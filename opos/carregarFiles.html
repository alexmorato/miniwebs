<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selecciona fitxers</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #0b1020; color: #e7ecff; margin: 0; padding: 0; }
    .center { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
    .msg { font-size: 1.3rem; color: #6ae0a7; margin: 40px 0 18px 0; letter-spacing: 0.5px; }
    .logbox {
      width: 90vw; max-width: 700px; min-height: 320px; background: #141a2a; color: #e7ecff;
      border: 1.5px solid #27304a; border-radius: 10px; font-family: monospace; font-size: 1.05rem;
      padding: 18px 14px; margin-bottom: 30px; box-shadow: 0 4px 18px #0002; white-space: pre-wrap; overflow-y: auto;
    }
    #comencarBtn { width: 100%; max-width: 300px; background: linear-gradient(180deg,#2aebad,#21c08d); color: #032217; font-weight: bold; font-size: 1.1rem; padding: 14px 0; border-radius: 12px; border: none; cursor: pointer; margin-top: 30px; }
    #comencarBtn:disabled { opacity: 0.5; pointer-events: none; }
    #tornarBtn {
      display: none;
      margin-top: 10px;
      width: 100%;
      max-width: 200px;
      background: #27304a;
      color: #e7ecff;
      font-size: 1.05rem;
      padding: 10px 0;
      border-radius: 10px;
      border: none;
      cursor: pointer;
    }
    .titulo {
      text-align: center;
      color: #6ae0a7;
      font-size: 2.2rem;
      font-weight: bold;
      margin-top: 32px;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <div class="center">
    <div class="titulo">Selecciona fitxers</div>
    <div class="logbox" id="logbox"></div>
    <button id="comencarBtn" disabled>començar!</button>
    <button id="tornarBtn">⬅️ Tornar</button>
  </div>
  <script>
    // (Animació de puntets eliminada)

    // Log helper
    const logbox = document.getElementById('logbox');
    function log(msg) {
      logbox.textContent += msg + '\n';
      logbox.scrollTop = logbox.scrollHeight;
    }

    // Obtener temas seleccionats
    let temas = [];
    try {
      temas = JSON.parse(localStorage.getItem('oposTest_temas') || '[]');
    } catch (e) { temas = []; }

    if (!temas.length) {
      log('No hi ha temes seleccionats.');
    } else {
      log('Temes seleccionats: ' + temas.join(', '));
      // Cargar manifest.json y buscar ficheros que empiecen por los temas seleccionats
      fetch('testfiles/manifest.json')
        .then(r => r.json())
        .then(manifest => {
          let files = Array.isArray(manifest) ? manifest : manifest.files;
          if (!Array.isArray(files)) {
            log('Manifest incorrecte.');
            return;
          }
          // Buscar ficheros que empiecen por algún tema
          let encontrados = [];
          temas.forEach(tema => {
            encontrados = encontrados.concat(files.filter(f => f.startsWith(tema)));
          });
          // Eliminar duplicados
          encontrados = [...new Set(encontrados)];
          if (!encontrados.length) {
            log('No s\'ha trobat cap fitxer per als temes seleccionats.');
            document.getElementById('comencarBtn').disabled = true;
            document.getElementById('tornarBtn').style.display = 'block';
            return;
          }
          log('Fitxers trobats: ' + encontrados.length);
          // Mostrar un botón por cada fichero encontrado (selección múltiple)
          const btnsDiv = document.createElement('div');
          btnsDiv.style.marginTop = '18px';
          let seleccionats = [];
          encontrados.forEach(fichero => {
            const btn = document.createElement('button');
            btn.textContent = fichero;
            btn.style.display = 'block';
            btn.style.width = '100%';
            btn.style.margin = '8px 0';
            btn.style.background = '#27304a';
            btn.style.color = '#e7ecff';
            btn.style.fontSize = '1.08rem';
            btn.style.border = '1px solid #2a3554';
            btn.style.borderRadius = '8px';
            btn.style.padding = '10px 0';
            btn.style.cursor = 'pointer';
            btn.onclick = function() {
              if (seleccionats.includes(fichero)) {
                // Deseleccionar
                seleccionats = seleccionats.filter(f => f !== fichero);
                btn.style.outline = '';
              } else {
                // Seleccionar
                seleccionats.push(fichero);
                btn.style.outline = '3px solid #6ae0a7';
              }
              // Guardar selección múltiple en localStorage
              localStorage.setItem('oposTest_fitxer', JSON.stringify(seleccionats));
              // Habilitar o deshabilitar el botón comenzar
              document.getElementById('comencarBtn').disabled = seleccionats.length === 0;
            };
            btnsDiv.appendChild(btn);
          });
          logbox.appendChild(btnsDiv);
          // Deshabilitar comenzar hasta que se seleccione al menos un fichero
          document.getElementById('comencarBtn').disabled = true;
        })
        .catch(() => {
          log('No s\'ha pogut carregar el manifest de fitxers.');
        });
    }

    // Acción del botón tornar
    document.getElementById('tornarBtn').onclick = function() {
      window.location.href = 'init.html';
    };

    document.getElementById('comencarBtn').onclick = function() {
      window.location.href = 'test.html';
    };
  </script>
</body>
</html>
