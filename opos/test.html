<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Opos</title>
  <style>
    .question-info {
      font-size: 0.93rem;
      color: #9fb0ff;
      margin-bottom: 7px;
    }
    body { font-family: system-ui, sans-serif; background: #0b1020; color: #e7ecff; margin: 0; padding: 10px; }
    .container { max-width: 800px; margin: 0 auto; }
    .header {
      text-align: center;
      color: #6ae0a7;
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #27304a;
      border-radius: 4px;
      /* margin-bottom: 30px; */
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #6ae0a7, #2aebad);
      transition: width 0.3s ease;
    }
    .question-card {
      background: #141a2a;
      border: 1.5px solid #27304a;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .question-number {
      font-size: 1rem;
      color: #9fb0ff;
      margin-bottom: 15px;
    }
    .question-text {
      font-size: 1.1rem;
      line-height: 1.5;
      margin-bottom: 25px;
      color: #e7ecff;
    }
    .answer-option {
      background: #27304a;
      border: 2px solid #2a3554;
      border-radius: 10px;
      padding: 5px 10px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      font-size: 1.1rem;
    }
    .answer-option:hover {
      border-color: #6ae0a7;
      background: #2a3554;
    }
    .answer-option.selected {
      border-color: #6ae0a7;
      background: rgba(106, 224, 167, 0.1);
      color: #6ae0a7;
    }
    .answer-option.correct {
      border-color: #6ae0a7;
      background: rgba(106, 224, 167, 0.2);
    }
    .answer-option.incorrect {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.2);
    }
    .option-content {
      flex: 1;
    }
    .option-text {
      color: #e7ecff;
      margin-bottom: 5px;
    }
    .feedback {
      font-weight: bold;
      margin: 10px 0 5px 0;
      font-size: 1rem;
    }
    .correct-feedback {
      color: #6ae0a7;
    }
    .incorrect-feedback {
      color: #ff6b6b;
    }
    .rationale {
      color: #c2d3ff;
      font-style: italic;
      font-size: 0.95rem;
      line-height: 1.4;
      margin-top: 5px;
    }
    .explanation {
      background: #0f1525;
      border-left: 4px solid #6ae0a7;
      padding: 20px;
      margin-top: 20px;
      border-radius: 0 8px 8px 0;
      font-style: italic;
      color: #c2d3ff;
    }
    .navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
    }
    .nav-btn {
      background: linear-gradient(180deg, #2aebad, #21c08d);
      color: #032217;
      font-weight: bold;
      font-size: 1.1rem;
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-btn:disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .nav-btn.secondary {
      background: #27304a;
      color: #e7ecff;
    }
    .nav-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(42, 235, 173, 0.3);
    }
    .results {
      text-align: center;
      padding: 40px 20px;
    }
    .score {
      font-size: 3rem;
      font-weight: bold;
      color: #6ae0a7;
      margin-bottom: 20px;
    }
    .score-text {
      font-size: 1.3rem;
      margin-bottom: 30px;
      color: #9fb0ff;
    }
    .historial-section {
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid #27304a;
    }
    .historial-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .historial-btn {
      background: #27304a;
      color: #e7ecff;
      font-size: 0.9rem;
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #2a3554;
      cursor: pointer;
      transition: all 0.2s;
    }
    .historial-btn:hover {
      background: #2a3554;
      border-color: #6ae0a7;
    }
    .historial-textarea {
      width: 100%;
      min-height: 200px;
      background: #141a2a;
      border: 1px solid #27304a;
      border-radius: 8px;
      color: #e7ecff;
      font-family: monospace;
      font-size: 0.85rem;
      padding: 15px;
      resize: vertical;
      box-sizing: border-box;
    }
    .historial-title {
      color: #6ae0a7;
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">Estic d'Opos</div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div id="questionContainer"></div>

    <div class="navigation">
      <button class="nav-btn secondary" id="prevBtn" onclick="previousQuestion()">‚Üê Anterior</button>
      <span id="questionCounter"></span>
      <button class="nav-btn" id="nextBtn" onclick="nextQuestion()">Seg√ºent ‚Üí</button>
    </div>

    <div class="historial-section">
      <div class="historial-title">Historial fallos</div>
      <div class="historial-buttons">
        <button class="historial-btn" onclick="copiarHistorial()">üìã Copia</button>
        <button class="historial-btn" onclick="baixarHistorial()">üíæ Baixa</button>
        <button class="historial-btn" onclick="guardarDubte()">‚ùì Guardar dubte</button>
        <button class="historial-btn" onclick="esborrarHistorial()">üóëÔ∏è Esborrar</button>
      </div>
      <textarea class="historial-textarea" id="historialFallos" readonly placeholder="Aqu√≠ apareixeran les preguntes fallades..."></textarea>
    </div>
  </div>

  <script>
    // --- Mapeo de dificultad ---
    let difficultyMap = {};
    fetch('assets/difficulty.json')
      .then(r => r.json())
      .then(arr => {
        arr.forEach(d => { difficultyMap[d.id] = d.text; });
      });

    function getDifficultyText(difficulty) {
      if (!difficulty) return 'D?';
      return difficultyMap[difficulty] || 'D?';
    }
    let preguntes = [];
    let currentQuestion = 0;
    let answers = [];
    let showingResults = false;
    let historialFallos = [];

    // Cargar preguntas del localStorage
    function loadQuestions() {
      try {
        preguntes = JSON.parse(localStorage.getItem('oposTest_preguntes') || '[]');
        // Reordenar aleatoriamente las preguntas
        preguntes = preguntes.sort(() => Math.random() - 0.5);
        if (!preguntes.length) {
          document.getElementById('questionContainer').innerHTML = 
            '<div class="question-card"><div class="question-text">No hi ha preguntes carregades.</div></div>';
          return false;
        }
        // Inicializar array de respuestas
        answers = new Array(preguntes.length).fill(null);
        return true;
      } catch (e) {
        document.getElementById('questionContainer').innerHTML = 
          '<div class="question-card"><div class="question-text">Error carregant les preguntes.</div></div>';
        return false;
      }
    }

    // Almacenar orden aleatorio de opciones por pregunta
    let shuffledOptions = [];

    // Mostrar pregunta actual
    function showQuestion(index) {
      if (index < 0 || index >= preguntes.length) return;
      
      const pregunta = preguntes[index];
      const container = document.getElementById('questionContainer');
      
      let html = `
        <div class="question-card">
          <div class="question-info">
            ${(pregunta.subjectId || '??') + '-' + (pregunta.origin || '??') + '-' + getDifficultyText(pregunta.difficulty)}
          </div>
          <div class="question-text">${pregunta.pregunta || pregunta.question || 'Pregunta no disponible'}</div>
      `;

      // Obtener opciones de respuesta (answerOptions)
      const answerOptions = pregunta.answerOptions || [];
      
      // Si no tenemos el orden aleatorio para esta pregunta, crearlo
      if (!shuffledOptions[index]) {
        shuffledOptions[index] = [...answerOptions].sort(() => Math.random() - 0.5);
      }
      
      const opciones = shuffledOptions[index];
      const userAnswered = answers[index] !== null;

      opciones.forEach((option, i) => {
        const isSelected = answers[index] === i;
        let optionClass = 'answer-option';
        
        if (userAnswered) {
          if (option.isCorrect) {
            optionClass += ' correct';
          } else if (isSelected && !option.isCorrect) {
            optionClass += ' incorrect';
          }
        } else if (isSelected) {
          optionClass += ' selected';
        }
        
        html += `
          <div class="${optionClass}" onclick="selectAnswer(${i})">
            <div class="option-content">
              <div class="option-text">${option.text}</div>`;
        
        // Mostrar feedback si ya se respondi√≥
        if (userAnswered) {
          if (option.isCorrect) {
            html += `
              <div class="feedback correct-feedback">‚úîÔ∏è Resposta correcta</div>
              <div class="rationale">${option.rationale || ''}</div>`;
          } else if (isSelected && !option.isCorrect) {
            html += `
              <div class="feedback incorrect-feedback">‚ùå Resposta incorrecta</div>
              <div class="rationale">${option.rationale || ''}</div>`;
          }
        }
        
        html += `
            </div>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
      
      // Actualizar contador y progreso
      document.getElementById('questionCounter').textContent = `${index + 1} / ${preguntes.length}`;
      const progressPercent = ((index + 1) / preguntes.length) * 100;
      document.getElementById('progressFill').style.width = progressPercent + '%';
      
      // Actualizar botones de navegaci√≥n
      document.getElementById('prevBtn').disabled = index === 0;
      document.getElementById('nextBtn').textContent = 
        index === preguntes.length - 1 ? 'Finalitzar' : 'Seg√ºent ‚Üí';
    }

    // Seleccionar respuesta
    function selectAnswer(optionIndex) {
      if (showingResults) return;
      if (answers[currentQuestion] !== null) return; // No permitir cambiar respuesta
      
      answers[currentQuestion] = optionIndex;
      
      // Verificar si la respuesta es incorrecta y guardar en historial
      const opciones = shuffledOptions[currentQuestion] || preguntes[currentQuestion].answerOptions || [];
      const selectedOption = opciones[optionIndex];
      if (selectedOption && !selectedOption.isCorrect) {
        guardarFalloEnHistorial(currentQuestion, optionIndex);
      }
      
      showQuestion(currentQuestion);
    }

    // Navegar a pregunta anterior
    function previousQuestion() {
      if (currentQuestion > 0) {
        currentQuestion--;
        showQuestion(currentQuestion);
      }
    }

    // Navegar a siguiente pregunta o finalizar test
    function nextQuestion() {
      if (currentQuestion < preguntes.length - 1) {
        currentQuestion++;
        showQuestion(currentQuestion);
      } else {
        showResults();
      }
    }

    // Mostrar resultados finales
    function showResults() {
      showingResults = true;
      let correctAnswers = 0;
      
      preguntes.forEach((pregunta, index) => {
        const opciones = shuffledOptions[index] || pregunta.answerOptions || [];
        const selectedOption = opciones[answers[index]];
        if (selectedOption && selectedOption.isCorrect) {
          correctAnswers++;
        }
      });
      
      const percentage = Math.round((correctAnswers / preguntes.length) * 100);
      
      const container = document.getElementById('questionContainer');
      container.innerHTML = `
        <div class="question-card results">
          <div class="score">${percentage}%</div>
          <div class="score-text">
            Has encertat ${correctAnswers} de ${preguntes.length} preguntes
          </div>
          <button class="nav-btn" onclick="reviewAnswers()">Revisar respostes</button>
          <button class="nav-btn secondary" onclick="restartTest()" style="margin-left: 15px;">Tornar a comen√ßar</button>
        </div>
      `;
      
      // Ocultar navegaci√≥n
      document.querySelector('.navigation').style.display = 'none';
    }

    // Revisar respuestas (mostrar correctas e incorrectas)
    function reviewAnswers() {
      showingResults = false;
      currentQuestion = 0;
      showQuestionWithAnswers(0);
      document.querySelector('.navigation').style.display = 'flex';
      document.getElementById('nextBtn').textContent = 'Seg√ºent ‚Üí';
    }

    // Mostrar pregunta con respuestas marcadas
    function showQuestionWithAnswers(index) {
      const pregunta = preguntes[index];
      const container = document.getElementById('questionContainer');
      const userAnswer = answers[index];
      
      let html = `
        <div class="question-card">
          <div class="question-info">
            ${(pregunta.subjectId || '??') + '-' + (pregunta.origin || '??') + '-D' + getDifficultyText(pregunta.difficulty)}
          </div>
          <div class="question-text">${pregunta.pregunta || pregunta.question}</div>
      `;

      const opciones = shuffledOptions[index] || pregunta.answerOptions || [];
      opciones.forEach((option, i) => {
        let className = 'answer-option';
        
        if (option.isCorrect) {
          className += ' correct';
        } else if (i === userAnswer && !option.isCorrect) {
          className += ' incorrect';
        }
        
        html += `
          <div class="${className}">
            <div class="option-content">
              <div class="option-text">${option.text}</div>`;
        
        // Mostrar feedback
        if (option.isCorrect) {
          html += `
            <div class="feedback correct-feedback">‚úîÔ∏è Resposta correcta</div>
            <div class="rationale">${option.rationale || ''}</div>`;
        } else if (i === userAnswer && !option.isCorrect) {
          html += `
            <div class="feedback incorrect-feedback">‚ùå Resposta incorrecta</div>
            <div class="rationale">${option.rationale || ''}</div>`;
        }
        
        html += `
            </div>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
      
      document.getElementById('questionCounter').textContent = `${index + 1} / ${preguntes.length}`;
      document.getElementById('prevBtn').disabled = index === 0;
      document.getElementById('nextBtn').textContent = 
        index === preguntes.length - 1 ? 'Tornar als resultats' : 'Seg√ºent ‚Üí';
    }

    // Reiniciar test
    function restartTest() {
      currentQuestion = 0;
      answers = new Array(preguntes.length).fill(null);
      showingResults = false;
      showQuestion(0);
      document.querySelector('.navigation').style.display = 'flex';
    }

    // Navegaci√≥n en modo revisi√≥n
    function nextQuestion() {
      if (showingResults) {
        if (currentQuestion < preguntes.length - 1) {
          currentQuestion++;
          showQuestionWithAnswers(currentQuestion);
        } else {
          showResults();
        }
      } else {
        if (currentQuestion < preguntes.length - 1) {
          currentQuestion++;
          showQuestion(currentQuestion);
        } else {
          showResults();
        }
      }
    }

    function previousQuestion() {
      if (currentQuestion > 0) {
        currentQuestion--;
        if (showingResults) {
          showQuestionWithAnswers(currentQuestion);
        } else {
          showQuestion(currentQuestion);
        }
      }
    }

    // Guardar fallo en historial
    function guardarFalloEnHistorial(questionIndex, selectedOptionIndex) {
      const pregunta = JSON.parse(JSON.stringify(preguntes[questionIndex])); // Deep copy
      const opciones = shuffledOptions[questionIndex] || pregunta.answerOptions || [];
      const user_guid = localStorage.getItem('user_guid') || localStorage.getItem('user_id') || 'unknown';
      
      // A√±adir user_guid a la pregunta
      pregunta.user_guid = user_guid;
      
      // Marcar la opci√≥n seleccionada por el usuario
      if (pregunta.answerOptions) {
        pregunta.answerOptions.forEach((option, i) => {
          const shuffledIndex = opciones.findIndex(shuffled => shuffled.text === option.text);
          if (shuffledIndex === selectedOptionIndex) {
            option.selectedByUser = true;
          }
        });
      }
      
      // A√±adir al principio del historial (m√°s nuevo primero)
      historialFallos.unshift(pregunta);
      actualizarTextareaHistorial();
    }

    // Guardar duda actual (independiente de si es correcta o no)
    function guardarDubte() {
      if (currentQuestion >= 0 && currentQuestion < preguntes.length) {
        const userAnswer = answers[currentQuestion];
        if (userAnswer !== null) {
          guardarFalloEnHistorial(currentQuestion, userAnswer);
        } else {
          // Si no hay respuesta, guardar sin marcar ninguna opci√≥n
          const pregunta = JSON.parse(JSON.stringify(preguntes[currentQuestion]));
          const user_guid = localStorage.getItem('user_guid') || localStorage.getItem('user_id') || 'unknown';
          pregunta.user_guid = user_guid;
          historialFallos.unshift(pregunta);
          actualizarTextareaHistorial();
        }
      }
    }

    // Borrar historial de fallos
    function esborrarHistorial() {
      if (confirm('Segur que vols esborrar tot l\'historial de fallos?')) {
        historialFallos = [];
        actualizarTextareaHistorial();
        localStorage.removeItem('oposTest_historialFallos');
      }
    }

    // Actualizar textarea del historial
    function actualizarTextareaHistorial() {
      const textarea = document.getElementById('historialFallos');
      textarea.value = JSON.stringify(historialFallos, null, 2);
    }

    // Copiar historial al portapapeles
    function copiarHistorial() {
      const textarea = document.getElementById('historialFallos');
      textarea.select();
      document.execCommand('copy');
      alert('Historial copiat al portapapers!');
    }

    // Descargar historial como archivo JSON
    function baixarHistorial() {
      const username = localStorage.getItem('oposTest_user') || 'usuario';
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
      const filename = `Errores_${username}_${timestamp}.json`;
      
      const blob = new Blob([JSON.stringify(historialFallos, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Inicializar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      if (loadQuestions()) {
        showQuestion(0);
      }
      // Cargar historial previo si existe
      try {
        const historialGuardado = localStorage.getItem('oposTest_historialFallos');
        if (historialGuardado) {
          historialFallos = JSON.parse(historialGuardado);
          actualizarTextareaHistorial();
        }
      } catch (e) {
        console.warn('Error cargando historial previo:', e);
      }
    });

    // Guardar historial en localStorage antes de salir
    window.addEventListener('beforeunload', function() {
      localStorage.setItem('oposTest_historialFallos', JSON.stringify(historialFallos));
    });
  </script>
</body>
</html>
