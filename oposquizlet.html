<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JSON ‚Üí Quizlet (Formatador de tests)</title>
  <style>
    :root { --bg:#0b1020; --card:#141a2a; --ink:#e7ecff; --muted:#9fb0ff; --accent:#6ae0a7; --warn:#ffb86b; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:linear-gradient(160deg,#0b1020,#121a33 35%,#0b1020);color:var(--ink)}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    header h1{font-size:clamp(20px,4vw,28px);margin:0}
    header .tag{background:var(--card);border:1px solid #27304a;padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .card{background:var(--card);border:1px solid #27304a;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .card h2{font-size:16px;margin:0 0 10px;color:var(--muted)}
    textarea{width:100%;min-height:340px;background:#0f1526;border:1px solid #27304a;border-radius:12px;color:var(--ink);padding:12px;line-height:1.45;font-size:14px;resize:vertical}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
    .controls label{display:flex;gap:8px;align-items:center;background:#0f1526;border:1px solid #27304a;padding:8px 10px;border-radius:10px;color:var(--muted);font-size:13px}
    input[type="text"], input[type="number"]{background:#0f1526;border:1px solid #27304a;border-radius:8px;color:var(--ink);padding:8px 10px;min-width:160px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    button{background:linear-gradient(180deg,#2aebad,#21c08d);border:none;color:#032217;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    button.secondary{background:#19213a;color:var(--ink);border:1px solid #27304a}
    button.warn{background:linear-gradient(180deg,#ffd27a,#ffb86b);color:#3a2300}
    .meta{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px;margin-top:8px}
    .footer{margin-top:18px;color:var(--muted);font-size:12px}
    .ok{color:var(--accent)} .bad{color:var(--bad)} .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>JSON ‚Üí Quizlet ¬∑ Formatador de tests</h1>
      <div class="tag">Tema 56 ¬∑ Backup 3‚Äë2‚Äë1 i ransomware</div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>1) Enganxa el teu JSON aqu√≠</h2>
        <div class="small">Format esperat per a cada pregunta:
          <span class="mono">{"nivell":"F√†cil üü¢","pregunta":"...","resposta_correcta":"...","respostes_incorrectes":["...","...","..."],"context":"..."}</span>
        </div>
        <textarea id="input" placeholder='[
  {"nivell":"F√†cil üü¢","pregunta":"Quin √©s l‚Äôobjectiu del backup?","resposta_correcta":"Garantir la disponibilitat i integritat","respostes_incorrectes":["Reduir costos","Augmentar la velocitat","Evitar el n√∫vol"],"context":"Sense backup no hi ha recuperaci√≥."}
]'></textarea>

        <div class="controls">
          <label><input type="checkbox" id="shuffle" checked> Barreja les opcions (A‚ÄëD)</label>
          <label>Seed opcional (repetible): <input type="text" id="seed" placeholder="per ex. tema56-bloc1"/></label>
          <label><input type="checkbox" id="balance"> Intenta equilibrar A/B/C/D (experimental)</label>
        </div>
        <div class="btns">
          <button id="convert">Convertir a format Quizlet</button>
          <button id="copy" class="secondary">Copiar resultat</button>
          <button id="download" class="secondary">Descarregar .txt</button>
          <button id="clear" class="warn">Netejar</button>
        </div>
        <div id="status" class="meta"></div>
      </section>

      <section class="card">
        <h2>2) Resultat (llest per a Quizlet)</h2>
        <textarea id="output" readonly placeholder="Aqu√≠ apareixer√† el text final‚Ä¶"></textarea>
        <div class="footer">El format generat segueix: nivell ‚Üí pregunta ‚Üí opcions A‚ÄëD ‚Üí ‚≠ê lletra i literal ‚Üí üëâ context ‚Üí <span class="mono">@@@</span></div>
      </section>
    </div>
  </div>

  <script>
    // Seedable PRNG (Mulberry32)
    function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
    function xhash(str){let h=2166136261>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,16777619)}return h>>>0}
    function shuffleInPlace(arr, rng){for(let i=arr.length-1;i>0;i--){const j=Math.floor((rng?rng():Math.random())*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}} 

    function toQuizlet(items,{doShuffle=true, seed='', balance=false}={}){
      const rng = seed ? mulberry32(xhash(seed)) : null;
      let counts = {A:0,B:0,C:0,D:0};
      const letters=['A','B','C','D'];
      const out=[]; let errors=[];

      items.forEach((q,idx)=>{
        const path = `#${idx+1}`;
        // Validate
        if(!q || typeof q!== 'object'){errors.push(`${path}: element inv√†lid`);return}
        const {nivell,pregunta,resposta_correcta,respostes_incorrectes,context} = q;
        if(!pregunta || !resposta_correcta || !Array.isArray(respostes_incorrectes)){
          errors.push(`${path}: camps requerits buits`);return
        }
        if(respostes_incorrectes.length < 3){errors.push(`${path}: calen 3 respostes incorrectes`);return}
        const wrong = respostes_incorrectes.slice(0,3);
        let options = [resposta_correcta, ...wrong];

        // Shuffle options
        if(doShuffle){
          shuffleInPlace(options, rng);
          if(balance){
            // Try to nudge the correct answer towards the least-used letter
            const currentIdx = options.indexOf(resposta_correcta);
            const sorted = Object.entries(counts).sort((a,b)=>a[1]-b[1]);
            const targetLetter = sorted[0][0];
            const targetIdx = letters.indexOf(targetLetter);
            // 30% chance to swap towards balance to avoid being too deterministic
            const pick = rng ? rng() : Math.random();
            if(currentIdx !== targetIdx && pick < 0.3){
              [options[currentIdx], options[targetIdx]] = [options[targetIdx], options[currentIdx]];
            }
          }
        }

        // Build block
        const correctIdx = options.indexOf(resposta_correcta);
        const correctLetter = letters[correctIdx];
        counts[correctLetter]++;
        const block = [
          `[${nivell||'Sense nivell'}]`,
          `${pregunta}`,
          `A) ${options[0]}`,
          `B) ${options[1]}`,
          `C) ${options[2]}`,
          `D) ${options[3]}`,
          `‚≠ê ${correctLetter}) ${resposta_correcta}`,
          `üëâ ${context||''}@@@`
        ].join('\n');
        out.push(block);
      });

      const txt = out.join('\n\n---\n\n');
      return {txt, counts, errors};
    }

    const $ = sel => document.querySelector(sel);
    const input = $('#input');
    const output = $('#output');
    const status = $('#status');

    $('#convert').addEventListener('click',()=>{
      let data;
      try{ data = JSON.parse(input.value.trim()); }
      catch(e){ output.value=''; status.innerHTML=`<span class="bad">‚ùå JSON inv√†lid:</span> ${e.message}`; return; }
      const res = toQuizlet(data, { doShuffle: $('#shuffle').checked, seed: $('#seed').value.trim(), balance: $('#balance').checked });
      output.value = res.txt;
      const {A,B,C,D} = res.counts;
      const err = res.errors.length ? ` ¬∑ <span class="bad">${res.errors.length} errors</span>` : '';
      status.innerHTML = `<span class="ok">‚úîÔ∏è Convertit</span> ¬∑ Distribuci√≥ correctes ‚Üí A:${A} B:${B} C:${C} D:${D}${err}`;
    });

    $('#copy').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(output.value); status.innerHTML = `<span class="ok">üìã Copiat al porta-retalls</span>`; }catch{ status.innerHTML = `<span class="bad">‚ùå No s'ha pogut copiar</span>`; }
    });

    $('#download').addEventListener('click',()=>{
      const blob = new Blob([output.value], {type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'quizlet.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $('#clear').addEventListener('click',()=>{ input.value=''; output.value=''; status.textContent=''; });
  </script>
</body>
</html>
